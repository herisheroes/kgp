<!DOCTYPE html>

<html lang="id">

<head>

<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Komandan Turbo : Misi Penjumlahan</title>

<style>

@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap');


body {

margin: 0;

overflow: hidden;

font-family: 'Orbitron', sans-serif;

background-color: #050510;

color: white;

user-select: none;

touch-action: none;

}


#game-container { position: relative; width: 100vw; height: 100vh; }

canvas { display: block; width: 100%; height: 100%; }


/* UI OVERLAYS - UPDATE BACKGROUND */

.screen {

position: absolute; top: 0; left: 0; width: 100%; height: 100%;

/* Background Image Baru */

background: url('https://raw.githubusercontent.com/herisheroes/kgp/refs/heads/main/backkt0.png') no-repeat center center;

background-size: cover;

z-index: 100;

display: flex; flex-direction: column; justify-content: center; align-items: center;

transition: opacity 0.5s;

}

/* Overlay gelap di atas background agar tulisan terbaca */

.screen::before {

content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;

background: rgba(0,0,0,0.6); z-index: -1;

}


.hide { display: none !important; }


h1 { color: #00eaff; font-size: 5vmin; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 5px; text-align: center; text-shadow: 0 0 20px #00eaff;}

h2 { color: #fff; font-size: 3vmin; margin-bottom: 30px; text-shadow: 0 0 10px black; }

p { color: #eee; max-width: 600px; text-align: center; font-size: 2vmin; line-height: 1.5; margin-bottom: 20px; text-shadow: 1px 1px 2px black;}


.btn-group { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }

.action-btn {

padding: 1.5vmin 4vmin; font-size: 2vmin;

background: rgba(0, 0, 0, 0.7); color: #00eaff;

border: 2px solid #00eaff; border-radius: 10px;

font-family: 'Orbitron', sans-serif; font-weight: bold;

cursor: pointer; transition: all 0.2s; text-transform: uppercase;

box-shadow: 0 0 10px rgba(0, 234, 255, 0.2);

}

.action-btn:hover, .action-btn.active {

background: #00eaff; color: #000; box-shadow: 0 0 30px #00eaff; transform: scale(1.1);

}


/* Loading Screen Specifics */

#loading-screen {

background: #000; /* Loading hitam polos atau background beda */

z-index: 200;

}

.loader-bar {

width: 300px; height: 10px; background: #333; border-radius: 5px;

margin-top: 20px; overflow: hidden; position: relative;

}

.loader-fill {

height: 100%; width: 0%; background: #00eaff;

box-shadow: 0 0 10px #00eaff;

transition: width 0.2s;

}

.loading-text {

font-size: 2vmin; color: #00eaff; animation: blink 1s infinite;

}


/* Start Button Besar di Splash */

.start-btn-large {

font-size: 4vmin; padding: 2vmin 6vmin;

background: linear-gradient(45deg, #00eaff, #008cff);

color: white; border: none; border-radius: 50px;

box-shadow: 0 0 40px rgba(0, 234, 255, 0.5);

animation: pulseBtn 2s infinite;

}


@keyframes pulseBtn {

0% { transform: scale(1); box-shadow: 0 0 20px rgba(0, 234, 255, 0.5); }

50% { transform: scale(1.05); box-shadow: 0 0 60px rgba(0, 234, 255, 0.8); }

100% { transform: scale(1); box-shadow: 0 0 20px rgba(0, 234, 255, 0.5); }

}

@keyframes blink { 50% { opacity: 0.5; } }


/* Level Cards */

.level-card {

background: rgba(0,0,0,0.8); border: 1px solid #444; padding: 20px; margin: 10px;

border-radius: 10px; width: 200px; text-align: center; cursor: pointer;

opacity: 0.5; pointer-events: none; transition: 0.3s;

}

.level-card.unlocked { opacity: 1; pointer-events: auto; border-color: #00eaff; }

.level-card:hover { background: rgba(0, 234, 255, 0.2); transform: translateY(-10px); border-color: #fff; box-shadow: 0 0 20px rgba(0,234,255,0.3); }


/* IN-GAME UI */

#game-ui {

position: absolute; top: 0; left: 0; width: 100%; height: 100%;

pointer-events: none; display: grid;

}

.grid-1 { grid-template-columns: 1fr; }

.grid-2 { grid-template-columns: 1fr 1fr; }

.grid-3 { grid-template-columns: 1fr 1fr 1fr; }

.grid-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }


.player-panel {

position: relative; border-right: 2px solid rgba(255,255,255,0.2);

box-sizing: border-box; pointer-events: none; overflow: hidden;

display: flex; flex-direction: column; justify-content: flex-end; padding: 10px;

}

.player-panel:last-child { border-right: none; }


.p-color-bar { position: absolute; top: 0; left: 0; width: 100%; height: 5px; }


.hud-top {

position: absolute; top: 15px; left: 10px; right: 10px;

display: flex; justify-content: space-between; align-items: flex-start;

}


.hud-info-box {

background: rgba(0,0,0,0.6); padding: 5px 10px;

border-radius: 5px; font-size: 1.5vmin; text-align: left;

border: 1px solid rgba(255,255,255,0.1);

}


.speed-box { text-align: right; font-size: 2vmin; color: #fff; text-shadow: 0 0 5px currentColor; }

.timer-display { font-family: monospace; font-size: 1.8vmin; color: #ffd700; margin-top: 5px; }


.quit-btn {

pointer-events: auto; background: rgba(255, 0, 0, 0.7); color: white;

border: 1px solid red; border-radius: 5px; padding: 5px 10px;

font-size: 1.5vmin; cursor: pointer; margin-left: 10px; font-family: 'Orbitron', sans-serif;

}

.quit-btn:hover { background: red; }


.minimap-container {

position: relative; width: 10px; height: 100px;

background: rgba(255,255,255,0.1); border: 1px solid #555;

border-radius: 5px; margin-left: 10px;

}

.minimap-marker {

position: absolute; left: -3px; width: 16px; height: 4px;

background: red; transition: bottom 0.2s linear; box-shadow: 0 0 2px black;

}


/* Math Panel Effects */

.math-box {

pointer-events: auto; background: rgba(0, 0, 0, 0.85);

border: 2px solid #fff; border-radius: 10px; padding: 10px;

text-align: center; width: 90%; margin: 0 auto 20px auto;

align-self: center; z-index: 20; box-shadow: 0 5px 15px rgba(0,0,0,0.5);

transition: transform 0.1s, border-color 0.2s, background-color 0.2s;

}

/* Animasi Benar */

.anim-correct {

border-color: #00ff66 !important;

background-color: rgba(0, 255, 102, 0.2) !important;

animation: popCorrect 0.3s ease-out;

}

@keyframes popCorrect {

0% { transform: scale(1); }

50% { transform: scale(1.1); }

100% { transform: scale(1); }

}


/* Animasi Salah */

.anim-wrong {

border-color: #ff3333 !important;

background-color: rgba(255, 51, 51, 0.2) !important;

animation: shakeWrong 0.4s ease-in-out;

}

@keyframes shakeWrong {

0%, 100% { transform: translateX(0); }

20%, 60% { transform: translateX(-10px); }

40%, 80% { transform: translateX(10px); }

}


.math-question { font-size: 3vmin; margin-bottom: 10px; color: #fff; }

.math-options { display: grid; grid-template-columns: 1fr; gap: 5px; }

@media (min-width: 800px) { .math-options { grid-template-columns: 1fr 1fr 1fr; } }


.math-btn {

background: #333; border: 1px solid #555; color: white;

padding: 1.5vmin; font-size: 2vmin; font-family: 'Orbitron', sans-serif;

cursor: pointer; border-radius: 5px; transition: background 0.1s;

}

.math-btn:hover { background: #444; border-color: #888; }

.math-btn:active { background: #fff; color: #000; }


.feedback-overlay {

position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);

font-size: 5vmin; font-weight: bold; opacity: 0; transition: opacity 0.3s;

text-shadow: 2px 2px 0 #000; white-space: nowrap; z-index: 30;

}


.lap-popup {

position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%) scale(0);

font-size: 8vmin; font-weight: bold; color: #ffd700;

text-shadow: 0 0 20px #ffaa00, 2px 2px 5px black;

transition: transform 0.5s, opacity 0.5s; opacity: 0; z-index: 50; pointer-events: none; white-space: nowrap;

}

.lap-popup.show { transform: translate(-50%, -50%) scale(1); opacity: 1; }


.finish-text {

position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);

font-size: 8vmin; font-weight: bold; color: #00eaff;

text-shadow: 0 0 20px #00eaff, 2px 2px 5px black;

display: none; z-index: 60;

}


#countdown-layer {

position: absolute; top: 0; left: 0; width: 100%; height: 100%;

display: flex; justify-content: center; align-items: center; pointer-events: none;

z-index: 50; background: rgba(0,0,0,0.3);

}

.countdown-text {

font-size: 20vmin; font-weight: bold; color: #fff;

animation: zoomPop 0.8s ease-out; text-shadow: 0 0 20px currentColor;

}

@keyframes zoomPop {

0% { transform: scale(0.5); opacity: 0; }

50% { transform: scale(1.2); opacity: 1; }

100% { transform: scale(1); opacity: 0; }

}


#game-over { background: rgba(0,0,0,0.95); }

#score-board { margin: 20px 0; width: 90%; max-width: 800px; }

.score-row { 

display: grid; grid-template-columns: 1fr 1fr 1fr; 

padding: 10px; border-bottom: 1px solid #333; 

font-size: 2vmin;

}

.score-header { font-weight: bold; color: #00eaff; border-bottom: 2px solid #00eaff; }

</style>

</head>

<body>

<div id="game-container"></div>


<!-- LOADING SCREEN -->

<div id="loading-screen" class="screen">

<h2 class="loading-text">MENGAMBIL DATA PEMBALAP DAN SIRKUIT...</h2>

<div class="loader-bar">

<div class="loader-fill" id="loader-fill"></div>

</div>

</div>


<!-- SPLASH SCREEN -->

<div id="splash-screen" class="screen hide">

<h1 style="font-size: 6vmin; margin-bottom: 5px;">KOMANDAN TURBO</h1>

<h2 style="color:#00eaff; font-size: 3vmin; letter-spacing: 5px;">MISI PENJUMLAHAN</h2>

<p style="margin-top: 50px;">SIAPKAN LOGIKA & KECEPATANMU</p>

<button class="action-btn start-btn-large" onclick="enterMainMenu()">START</button>

</div>


<!-- MAIN MENU -->

<div id="main-menu" class="screen hide">

<h1>MAIN MENU</h1>

<div class="btn-group">

<button class="action-btn" onclick="showStoryMenu()">Story Mode</button>

<button class="action-btn" onclick="showVersusMenu()">Versus Mode</button>

</div>

</div>


<!-- STORY MODE SELECT -->

<div id="story-menu" class="screen hide">

<h1>Story Mode</h1>

<h2>Pilih Sirkuit</h2>

<div id="story-points" style="color: #ffd700; margin-bottom: 20px; font-size: 2.5vmin; text-shadow: 2px 2px 0 black;">Total Poin Musim: 0</div>

<div id="level-container" class="btn-group"></div>

<button class="action-btn" style="margin-top: 30px;" onclick="goToMainMenu()">Kembali</button>

</div>


<!-- VERSUS SETUP -->

<div id="versus-menu" class="screen hide">

<h1>Versus Mode</h1>

<p>Setup Multiplayer</p>

<div style="margin-bottom: 20px;">

<h2>Jumlah Pemain</h2>

<div class="btn-group" id="player-select">

<button class="action-btn" onclick="setPlayers(2)">2 Player</button>

<button class="action-btn" onclick="setPlayers(3)">3 Player</button>

<button class="action-btn" onclick="setPlayers(4)">4 Player</button>

</div>

</div>

<div style="margin-bottom: 20px;">

<h2>Jumlah Lap</h2>

<div class="btn-group" id="lap-select">

<button class="action-btn" onclick="setLaps(1)">1 Lap</button>

<button class="action-btn" onclick="setLaps(3)">3 Lap</button>

<button class="action-btn" onclick="setLaps(5)">5 Lap</button>

</div>

</div>

<button class="action-btn" style="margin-top: 20px; background: #00eaff; color: #000;" onclick="startVersus()">MULAI BALAPAN</button>

<button class="action-btn" style="margin-top: 10px;" onclick="goToMainMenu()">Kembali</button>

</div>


<!-- IN-GAME UI -->

<div id="game-ui" class="hide"></div>

<div id="countdown-layer" class="hide"></div>


<!-- GAME OVER -->

<div id="game-over" class="screen hide">

<h1>HASIL BALAPAN</h1>

<div id="score-board"></div>

<button class="action-btn" onclick="goToMainMenu()">Menu Utama</button>

</div>


<!-- Import Three.js -->

<script type="importmap">

{

"imports": {

"three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"

}

}

</script>


<script type="module">

import * as THREE from 'three';


// --- ASSET CONFIG ---

const ASSETS = {

body: 'https://raw.githubusercontent.com/herisheroes/kgp/refs/heads/main/bikebody.png',

road: 'https://raw.githubusercontent.com/herisheroes/kgp/refs/heads/main/road.png',

sky: 'https://raw.githubusercontent.com/herisheroes/kgp/refs/heads/main/skybox.png',

tire: 'https://raw.githubusercontent.com/herisheroes/kgp/refs/heads/main/tire.png'

};


const COLORS = [0x00eaff, 0xff3333, 0x00ff66, 0xffaa00, 0xaa00ff, 0x00ffff];

const ROAD_LENGTH = 1000;

const LAP_DISTANCE = 3000;

const POINTS_SYSTEM = [10, 8, 6, 4, 2, 0];

const STORY_LEVELS = [

{ id: 1, name: "Tutorial Track", laps: 1, aiSpeed: 0.6, locked: false },

{ id: 2, name: "Speedway", laps: 2, aiSpeed: 0.9, locked: true },

{ id: 3, name: "Hyper Lane", laps: 3, aiSpeed: 1.2, locked: true },

{ id: 4, name: "Champion Road", laps: 4, aiSpeed: 1.5, locked: true }

];


let scene, renderer, textureLoader;

let texBody, texRoad, texSky, texTire; 

let roads = [];

let players = [];

let finishOrder = []; 

let globalSeasonPoints = 0; 


let gameActive = false;

let isCountingDown = false;

let currentMode = 'STORY'; 

let setupData = { playerCount: 1, laps: 2 };

let raceStartTime = null;


// --- INITIAL LOADING ---

window.onload = function() {

// Simulasi Loading

let progress = 0;

const bar = document.getElementById('loader-fill');

const interval = setInterval(() => {

progress += Math.random() * 5;

if(progress > 100) progress = 100;

bar.style.width = progress + "%";

if(progress === 100) {

clearInterval(interval);

setTimeout(() => {

document.getElementById('loading-screen').classList.add('hide');

document.getElementById('splash-screen').classList.remove('hide');

}, 500);

}

}, 50);

};


window.enterMainMenu = function() {

document.getElementById('splash-screen').classList.add('hide');

document.getElementById('main-menu').classList.remove('hide');

}


// --- HELPER UTILS ---

function formatTime(ms) {

if (!ms) return "--:--.--";

let min = Math.floor(ms / 60000);

let sec = Math.floor((ms % 60000) / 1000);

let centi = Math.floor((ms % 1000) / 10);

return `${min}:${sec.toString().padStart(2, '0')}.${centi.toString().padStart(2, '0')}`;

}


// --- PLAYER CLASS ---

class Player {

constructor(id, color, isAI = false, startOffset = 0) {

this.id = id;

this.color = color;

this.isAI = isAI;

this.lap = 1;

this.distance = 0;

this.speed = 0;

this.maxSpeed = 2.0;

this.combo = 0;

this.finished = false;

this.finishTime = 0;

this.hasQuit = false;

this.baseX = startOffset * 2.5; 

this.mesh = createBike(color);

this.mesh.position.set(this.baseX, 0, 0);

this.camera = new THREE.PerspectiveCamera(60, 1, 0.1, 1000);

this.camera.position.set(this.baseX, 3, 7);

this.camera.rotation.x = -0.25;


this.correctIndex = 0;

}


update() {

if (this.hasQuit) return;

if (this.finished) {

if (this.speed > 0) {

this.speed -= 0.02;

this.mesh.position.z -= this.speed;

this.camera.position.z = this.mesh.position.z + 7;

}

return; 

}


if (isCountingDown) return;


if (this.isAI) {

let targetSpeed = setupData.aiSpeed || 0.8;

targetSpeed *= (0.9 + (this.id % 3) * 0.05); 

let leadDistance = 0;

players.forEach(p => { if(!p.isAI && p.distance > leadDistance) leadDistance = p.distance; });

if (leadDistance > this.distance + 150) targetSpeed *= 1.3;

this.speed = THREE.MathUtils.lerp(this.speed, targetSpeed, 0.05);

} else {

if (this.speed > 0.5) this.speed -= 0.003;

}


const moveStep = this.speed;

this.mesh.position.z -= moveStep;

this.distance += moveStep;


this.mesh.position.x = this.baseX; 

this.mesh.rotation.y = 0; 


const targetCamZ = this.mesh.position.z + 7;

this.camera.position.z = targetCamZ;

this.camera.position.x = this.baseX; 

this.camera.rotation.z = 0; 


if (this.distance >= LAP_DISTANCE * this.lap) {

if (this.lap >= setupData.laps) {

this.finishRace();

} else {

this.lap++;

this.showLapPopup();

this.updateHUD(); 

}

}

this.updateHUDStats();

}


quitRace() {

if (this.finished || this.hasQuit) return;

this.hasQuit = true;

this.speed = 0;

const panel = document.getElementById(`panel-p${this.id}`);

if (panel) {

const finishText = panel.querySelector('.finish-text');

finishText.innerText = "GAVE UP";

finishText.style.color = "red";

finishText.style.display = "block";

panel.querySelector('.math-box').style.display = 'none';

}

checkAllFinished();

}


finishRace() {

this.finished = true;

this.finishTime = Date.now() - raceStartTime;

finishOrder.push(this);

if (!this.isAI) {

const panel = document.getElementById(`panel-p${this.id}`);

if (panel) {

panel.querySelector('.finish-text').style.display = "block";

panel.querySelector('.math-box').style.display = 'none';

}

}

checkAllFinished();

}


showLapPopup() {

if(this.isAI) return;

const popup = document.getElementById(`lap-popup-p${this.id}`);

if(popup) {

popup.innerText = `LAP ${this.lap}`;

popup.classList.add('show');

setTimeout(() => { popup.classList.remove('show'); }, 1500);

}

}


generateMath() {

if (this.isAI || this.finished || this.hasQuit) return; 

const level = Math.floor(this.combo / 3) + 1;

const max = level * 10;

const min = (level - 1) * 5;

const a = Math.floor(Math.random() * (max - min)) + min + 1;

const b = Math.floor(Math.random() * (max - min)) + min + 1;

const ans = a + b;


let opts = [ans];

while(opts.length < 3) {

let r = ans + Math.floor(Math.random() * 10) - 5;

if(r > 0 && !opts.includes(r)) opts.push(r);

}

opts.sort(() => Math.random() - 0.5);

this.correctIndex = opts.indexOf(ans);

const panel = document.getElementById(`panel-p${this.id}`);

if(panel) {

panel.querySelector('.math-question').innerText = `${a} + ${b} = ?`;

const btns = panel.querySelectorAll('.math-btn');

btns.forEach((btn, i) => {

btn.innerText = opts[i];

btn.onclick = () => this.answer(i);

});

}

}


answer(idx) {

if(this.finished || this.hasQuit) return;

const feedback = document.getElementById(`fb-p${this.id}`);

const panel = document.getElementById(`panel-p${this.id}`);

const mathBox = panel.querySelector('.math-box');


// Reset animasi lama

mathBox.classList.remove('anim-correct', 'anim-wrong');

void mathBox.offsetWidth; // Trigger reflow


if (idx === this.correctIndex) {

this.combo++;

this.speed = Math.min(this.speed + 0.6, 3.5); 

feedback.innerText = "NICE!"; feedback.style.color = "#00ff66";

mathBox.classList.add('anim-correct');

} else {

this.combo = 0; this.speed = 0.5; 

feedback.innerText = "RESET!"; feedback.style.color = "#ff3333";

mathBox.classList.add('anim-wrong');

}

feedback.style.opacity = 1;

setTimeout(() => feedback.style.opacity = 0, 500);

this.generateMath();

}


updateHUD() {

const panel = document.getElementById(`panel-p${this.id}`);

if(panel) panel.querySelector('.lap-info').innerText = `Lap: ${this.lap}/${setupData.laps}`;

}


updateHUDStats() {

const panel = document.getElementById(`panel-p${this.id}`);

if(panel && !this.isAI) {

const speedVal = Math.floor(this.speed * 100);

panel.querySelector('.speed-text').innerText = `${speedVal} km/h`;


if (raceStartTime && !this.finished && !this.hasQuit) {

panel.querySelector('.timer-display').innerText = formatTime(Date.now() - raceStartTime);

} else if (this.finished) {

panel.querySelector('.timer-display').innerText = formatTime(this.finishTime);

}


const totalDist = LAP_DISTANCE * setupData.laps;

players.forEach(enemy => {

const enemyPct = Math.min((enemy.distance / totalDist) * 100, 100);

const marker = document.getElementById(`marker-p${enemy.id}-in-p${this.id}`);

if(marker) marker.style.bottom = `${enemyPct}%`;

});

}

}

}


// --- 3D SETUP ---

function initScene() {

const container = document.getElementById('game-container');

container.innerHTML = '';


scene = new THREE.Scene();

textureLoader = new THREE.TextureLoader();

texSky = textureLoader.load(ASSETS.sky, () => {

texSky.mapping = THREE.EquirectangularReflectionMapping;

scene.background = texSky;

});

scene.background = new THREE.Color(0x050510);

texRoad = textureLoader.load(ASSETS.road);

texRoad.wrapS = THREE.RepeatWrapping; texRoad.wrapT = THREE.RepeatWrapping;

texRoad.repeat.set(1, 20); 

texBody = textureLoader.load(ASSETS.body);

texTire = textureLoader.load(ASSETS.tire);


scene.fog = new THREE.Fog(0x1a1a2e, 20, 150);

const amb = new THREE.AmbientLight(0xffffff, 0.8); scene.add(amb);

const dir = new THREE.DirectionalLight(0xffffff, 1.5); dir.position.set(10, 20, 10); scene.add(dir);


renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });

renderer.setSize(window.innerWidth, window.innerHeight);

renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

renderer.setScissorTest(true); 

container.appendChild(renderer.domElement);


for(let i=0; i<10; i++) { createRoadSegment(-(ROAD_LENGTH/2) - (ROAD_LENGTH * i)); }

}


function createRoadSegment(zPos) {

const geo = new THREE.PlaneGeometry(60, ROAD_LENGTH, 1, 1);

const mat = new THREE.MeshStandardMaterial({ map: texRoad, roughness: 0.8, color: 0xaaaaaa });

const mesh = new THREE.Mesh(geo, mat);

mesh.rotation.x = -Math.PI/2; mesh.position.z = zPos; mesh.frustumCulled = false;

scene.add(mesh); roads.push(mesh);

}


function createBike(color) {

const g = new THREE.Group();

const bGeo = new THREE.BoxGeometry(0.8, 0.6, 1.8);

const bMat = new THREE.MeshStandardMaterial({ map: texBody, color: color, roughness: 0.4, metalness: 0.5 });

const body = new THREE.Mesh(bGeo, bMat); body.position.y = 0.6; g.add(body);


const wGeo = new THREE.BoxGeometry(0.7, 0.3, 0.5);

const wMat = new THREE.MeshPhongMaterial({ color: 0x000000, opacity: 0.8, transparent: true });

const wind = new THREE.Mesh(wGeo, wMat); wind.position.set(0, 1.0, -0.4); wind.rotation.x = -0.4; g.add(wind);


const wheelGeo = new THREE.CylinderGeometry(0.4, 0.4, 0.25, 32);

const wheelMat = new THREE.MeshStandardMaterial({ map: texTire, color: 0xffffff, roughness: 0.8 });

const w1 = new THREE.Mesh(wheelGeo, wheelMat); w1.rotation.z = Math.PI / 2; w1.position.set(0, 0.4, -1.0);

const w2 = new THREE.Mesh(wheelGeo, wheelMat); w2.rotation.z = Math.PI / 2; w2.position.set(0, 0.4, 1.0);

g.add(w1); g.add(w2);

return g;

}


// --- GAME LOOP ---

function animate() {

if (!gameActive) return;

requestAnimationFrame(animate);


let trailingZ = -Infinity;

players.forEach(p => { if(p.mesh.position.z > trailingZ) trailingZ = p.mesh.position.z; });


roads.forEach(r => {

if (r.position.z > (trailingZ + ROAD_LENGTH/2 + 200)) { 

let frontZ = Infinity;

roads.forEach(road => { if(road.position.z < frontZ) frontZ = road.position.z; });

r.position.z = frontZ - ROAD_LENGTH;

}

});


players.forEach(p => p.update());


const width = window.innerWidth;

const height = window.innerHeight;

renderer.setSize(width, height);


let n = players.length;

if (currentMode === 'STORY') n = 1; 


const stripWidth = width / n;


players.forEach((p, i) => {

if (i >= n) return;

const left = i * stripWidth;

renderer.setViewport(left, 0, stripWidth, height);

renderer.setScissor(left, 0, stripWidth, height);

p.camera.aspect = stripWidth / height;

p.camera.updateProjectionMatrix();

renderer.render(scene, p.camera);

});

}


// --- COUNTDOWN & STATE ---

function startCountdown() {

isCountingDown = true;

raceStartTime = null;

const layer = document.getElementById('countdown-layer');

layer.classList.remove('hide');

layer.innerHTML = '';

let count = 3;

function showNumber() {

if (count > 0) {

layer.innerHTML = `<div class="countdown-text" style="color:red">${count}</div>`;

count--; setTimeout(showNumber, 1000);

} else if (count === 0) {

layer.innerHTML = `<div class="countdown-text" style="color:#00ff66">GO!</div>`;

raceStartTime = Date.now();

count--; setTimeout(showNumber, 1000);

} else {

layer.classList.add('hide');

isCountingDown = false;

}

}

showNumber();

}


function checkAllFinished() {

if (players.every(p => p.finished || p.hasQuit)) {

setTimeout(showGameOver, 2000);

}

}


// --- MENU LOGIC ---

window.startStoryLevel = function(levelId) {

const lvl = STORY_LEVELS.find(l => l.id === levelId);

if (lvl.locked) return;

currentMode = 'STORY';

setupData = { playerCount: 1, laps: lvl.laps, aiSpeed: lvl.aiSpeed };

startGame();

}

window.startVersus = function() { currentMode = 'VERSUS'; startGame(); }


window.quitGame = function(playerId) {

if(players[playerId]) {

players[playerId].quitRace();

}

}


function startGame() {

document.querySelectorAll('.screen').forEach(el => el.classList.add('hide'));

document.getElementById('game-ui').classList.remove('hide');

initScene();

players = [];

finishOrder = []; 

const uiContainer = document.getElementById('game-ui');

uiContainer.innerHTML = '';

uiContainer.className = '';

let uiCount = (currentMode === 'STORY') ? 1 : setupData.playerCount;

let totalBikes = (currentMode === 'STORY') ? 5 : setupData.playerCount;

uiContainer.classList.add(`grid-${uiCount}`);


for (let i = 0; i < uiCount; i++) {

let startOffset = i - (totalBikes - 1) / 2;

let p = new Player(i, COLORS[i], false, startOffset);

players.push(p);

scene.add(p.mesh);


let markersHTML = `<div id="marker-p${i}-in-p${i}" class="minimap-marker" style="background:${'#'+COLORS[i].toString(16)}; z-index:2; border:1px solid white;"></div>`;

for(let j=0; j<totalBikes; j++) {

if(j!==i) markersHTML += `<div id="marker-p${j}-in-p${i}" class="minimap-marker" style="background: white; width:12px; left:-1px;"></div>`;

}


const panel = document.createElement('div');

panel.className = `player-panel`;

panel.id = `panel-p${i}`;

panel.innerHTML = `

<div class="p-color-bar" style="background:${'#'+COLORS[i].toString(16)}"></div>

<div class="hud-top">

<div class="hud-info-box">

<div style="color:${'#'+COLORS[i].toString(16)}; font-weight:bold;">P${i+1}</div>

<div class="lap-info" style="color:#aaa;">Lap 1/${setupData.laps}</div>

<div class="timer-display">0:00.00</div>

</div>

<div style="display:flex; align-items:center;">

<div class="speed-box hud-info-box"><span class="speed-text">0 km/h</span></div>

<div class="minimap-container">${markersHTML}</div>

<button class="quit-btn" onclick="quitGame(${i})">QUIT</button>

</div>

</div>

<div class="feedback-overlay" id="fb-p${i}">NICE!</div>

<div class="lap-popup" id="lap-popup-p${i}">LAP 2</div>

<div class="finish-text">FINISH!</div>

<div class="math-box">

<div class="math-question">Ready?</div>

<div class="math-options">

<button class="math-btn">A</button><button class="math-btn">B</button><button class="math-btn">C</button>

</div>

</div>

`;

uiContainer.appendChild(panel);

p.generateMath();

}


if (currentMode === 'STORY') {

for(let j=1; j<=4; j++) {

let startOffset = j - (totalBikes - 1) / 2;

let ai = new Player(j, COLORS[j], true, startOffset);

players.push(ai);

scene.add(ai.mesh);

let aiMarker = document.getElementById(`marker-p${j}-in-p0`);

if(aiMarker) aiMarker.style.background = '#' + COLORS[j].toString(16);

}

}


gameActive = true;

animate();

startCountdown();

}


function showGameOver() {

gameActive = false;

document.getElementById('game-ui').classList.add('hide');

const goScreen = document.getElementById('game-over');

goScreen.classList.remove('hide');

const sb = document.getElementById('score-board');

sb.innerHTML = `

<div class="score-row score-header">

<span>Pos</span>

<span>Pembalap</span>

<span>Waktu & Poin</span>

</div>

`;


let rankedPlayers = [...finishOrder];

players.forEach(p => {

if (!finishOrder.includes(p)) {

rankedPlayers.push(p);

}

});


rankedPlayers.forEach((p, idx) => {

let name = p.isAI ? `CPU Opponent ${p.id}` : `Player ${p.id+1}`;

let timeStr = p.finished ? formatTime(p.finishTime) : "DNF (Gave Up)";

let points = (p.finished && idx < POINTS_SYSTEM.length) ? POINTS_SYSTEM[idx] : 0;

if (currentMode === 'STORY' && !p.isAI) {

globalSeasonPoints += points;

}


let row = document.createElement('div');

row.className = 'score-row';

if(p.id === 0 && currentMode === 'STORY') row.style.border = "2px solid #00eaff"; 


row.innerHTML = `

<span style="color:${'#'+p.color.toString(16)}">#${idx+1}</span> 

<span>${name}</span> 

<span>${timeStr} <b style="color:#ffd700">(+${points} Pts)</b></span>

`;

sb.appendChild(row);

});


if (currentMode === 'STORY') {

let playerRank = rankedPlayers.findIndex(p => p.id === 0);

if (playerRank !== -1 && playerRank < 3 && rankedPlayers[playerRank].finished) {

unlockNextLevel();

let msg = document.createElement('div');

msg.innerHTML = `<h3 style="color:#00ff66">SELAMAT! LEVEL BERIKUTNYA TERBUKA</h3>`;

sb.appendChild(msg);

} else {

let msg = document.createElement('div');

msg.innerHTML = `<h3 style="color:#ff3333">GAGAL PODIUM. COBA LAGI!</h3>`;

sb.appendChild(msg);

}

let totalDiv = document.createElement('div');

totalDiv.innerHTML = `<h2 style="margin-top:20px; color:#ffd700">TOTAL POIN MUSIM: ${globalSeasonPoints}</h2>`;

sb.appendChild(totalDiv);

}

}


function unlockNextLevel() {

let currentLvlObj = STORY_LEVELS.find(l => l.laps === setupData.laps && l.aiSpeed === setupData.aiSpeed);

if (currentLvlObj) {

let nextIdx = STORY_LEVELS.indexOf(currentLvlObj) + 1;

if (nextIdx < STORY_LEVELS.length) STORY_LEVELS[nextIdx].locked = false;

}

}


window.goToMainMenu = () => { gameActive = false; toggleScreen('main-menu'); };

window.showStoryMenu = () => {

toggleScreen('story-menu');

document.getElementById('story-points').innerText = `Total Poin Musim: ${globalSeasonPoints}`;

const cont = document.getElementById('level-container');

cont.innerHTML = '';

STORY_LEVELS.forEach(lvl => {

const div = document.createElement('div');

div.className = `level-card ${lvl.locked ? '' : 'unlocked'}`;

div.innerHTML = `<h3>${lvl.name}</h3><p>${lvl.laps} Laps</p>`;

if(!lvl.locked) div.onclick = () => startStoryLevel(lvl.id);

cont.appendChild(div);

});

};

window.showVersusMenu = () => { toggleScreen('versus-menu'); setPlayers(2); setLaps(3); };

window.setPlayers = (n) => { setupData.playerCount = n; updateBtnGroup('player-select', n + ' Player'); };

window.setLaps = (n) => { setupData.laps = n; updateBtnGroup('lap-select', n + ' Lap'); };

function toggleScreen(id) { document.querySelectorAll('.screen').forEach(el => el.classList.add('hide')); document.getElementById(id).classList.remove('hide'); }

function updateBtnGroup(id, txt) { document.getElementById(id).querySelectorAll('button').forEach(b => { if(b.innerText.includes(txt)) b.classList.add('active'); else b.classList.remove('active'); }); }

</script>

</body>

</html>

